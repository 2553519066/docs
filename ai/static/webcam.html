<!DOCTYPE html>
<html lang="zh">
	<head>
		<meta charset="UTF-8">
		<meta name="divport" content="width=device-width, initial-scale=1.0">
		<title>åˆ›å»ºæ•°å­—äºº</title>
		<!-- ä½¿ç”¨ BootCDN çš„ Vue 2 CDN é“¾æ¥ -->
		<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.14/vue.min.js"></script>
		<!-- å¼•å…¥ Vue.js -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script> -->
		<style>
			/* ä¿ç•™ä½ çš„æ ·å¼ */
			body {
				/* padding-top: calc(160rpx + var(--status-bar-height)); */
				font-family: Arial, sans-serif;
				/* width: 375px; */
				/* margin-top: 64px; */
				height: calc(100vh - 64px);
				margin: 64px 0px 0px 0px;
			}

			.flex-between {
				width: calc(100% - 26px);
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 0 13px;
				height: 44px;
			}

			.top-item {
				font-size: 14px;
				color: #808080;
				position: relative;
				cursor: pointer;
			}

			.top-item.active {
				color: #000000;
			}

			.top-item.active::after {
				content: '';
				width: 40px;
				height: 4px;
				position: absolute;
				top: 24px;
				left: 30%;
				border-radius: 4px;
				background: #2FB3FB;
			}

			.tab-content {
				display: none;
			}

			.tab-content.active {
				display: block;
			}

			.ac {
				text-align: center;
			}



			.mt30 {
				margin-top: 30px;
			}

			.mt10 {
				margin-top: 10px;
			}

			.mt20 {
				margin-top: 20px;
			}

			.mt90 {
				margin-top: 90px;
			}

			.video-box {
				width: 100%;
				height: 269px;
				border-radius: 8px;
				position: relative;
				margin: 7px auto;
			}

			.trash-box {
				width: 38px;
				height: 38px;
				border-radius: 50%;
				background: #FFFFFF;
				position: absolute;
				top: 10px;
				right: 10px;
				z-index: 999;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
			}

			.text-box {
				width: 290px;
				height: 61px;
				opacity: 1;
				border-radius: 4px;
				background: #0000007F;
				z-index: 999;
				display: flex;
				align-items: center;
				justify-content: center;
				color: #ffffff;
				position: absolute;
				top: 80px;
				left: 20px;
			}

			.video {
				width: 333px;
				height: 269px;
				border-radius: 8px;
				object-fit: cover;
			}

			.videoShow {
				margin: 15px auto;
				width: 124px;
				height: 204px;
				border-radius: 8px;
				background: black;
			}

			.verticalVideo {
				width: 124px;
				height: 204px;
				border-radius: 8px;
				object-fit: cover;
				flex-direction: column;
			}

			.xuanfu {
				width: 100%;
				position: absolute;
				top: 108px;
				left: 0px;
				z-index: 999;
				height: calc(100vh - 108px);
			}

			.text {
				font-size: 14px;
				font-weight: 400;
			}

			.text1 {
				font-size: 12px;
				font-weight: 400;
				margin: 15px auto;
			}

			.text2 {
				font-size: 18px;
				font-weight: 400;
			}

			.text3 {
				color: #808080;
			}

			.text4 {
				font-size: 14px;
				color: #000000;
				margin-bottom: 20px;
				text-align: center;
			}

			.text5 {
				width: 100%;
				text-align: center;
				font-size: 16px;
				color: #323234;
			}



			.flex-start {
				display: flex;
				align-items: center;
				margin-bottom: 10px;
				cursor: pointer;
			}

			.ml10 {
				margin-left: 10px;
			}

			.ml20 {
				margin-left: 20px;
			}


			.btn {
				border-radius: 18px;
				background: #2FB3FB !important;
				color: white !important;
				border: none;
				padding: 12px 20px;
				font-size: 16px;
				cursor: pointer;
			}

			.btn1 {
				border-radius: 18px;
				background: #F2F2F2;
				color: #808080;
				border: none;
				padding: 12px 20px;
				font-size: 14px;
			}

			.btn2 {
				width: 154px;
				height: 34px;
				border-radius: 18px;
				border: 1px solid #2FB3FB;
				line-height: 34px;
				text-align: center;
				font-size: 14px;
				color: #2FB3FB;
				margin: 20px auto 0px;
				background: white;
			}

			.width163 {
				height: 40px;
				padding: 0px;
				width: 163px;
				border-radius: 18px;
			}

			button {
				background-color: #43CF80;
				color: white;
				border: none;
				padding: 10px 20px;
				font-size: 16px;
				border-radius: 4px;
				cursor: pointer;
			}

			.camera-box {
				width: 100%;
				height: 100%;
				/* background-color: #777; */
				/* padding: 20px 15px 42px 15px; */
				position: absolute;
				top: 0px;
				left: 0px;
				display: flex;
				flex-direction: column;
				align-items: center;
			}

			.camera-bor {
				width: 253px;
				height: 292px;
				border-radius: 110px 110px 130px 130px;
				border: 6px solid #FFFFFF;
				margin: 30px auto 0px auto;
				position: relative;
			}

			.camera-text {
				width: 316px;
				/* height: 227px; */
				border-radius: 8px;
				background: #00000033;
				position: absolute;
				top: 30px;
				left: -42px;
				color: #FFFFFF;
				text-align: center;
				padding: 10px;
			}

			.endTime {
				font-size: 60px;
				font-weight: 700;
				color: #FFFFFF;
				display: none;
			}

			.countdown {
				width: 160px;
				height: 45px;
				border-radius: 20px;
				background: #000000;
				font-size: 24px;
				font-weight: 700;
				color: #FFFFFF;
				text-align: center;
				line-height: 45px;
				/* display: none; */
			}

			.grid {
				display: grid;
				grid-template-columns: repeat(2, 1fr);
				gap: 10px;
				width: 100%;
				margin: 20px auto;
				font-family: sans-serif;
			}

			.option {
				display: flex;
				align-items: center;
				gap: 5px;
				cursor: pointer;
			}

			.circle {
				position: relative;
				/* ç¡®ä¿ ::before å¯ä»¥ç»å¯¹å®šä½ */
				width: 16px;
				height: 16px;
				border-radius: 50%;
				border: 1px solid #A6A6A6;
				background-color: white;
				flex-shrink: 0;
				transition: background-color 0.3s ease;
				display: flex;
				justify-content: center;
				align-items: center;
			}

			.circle.selected {
				background-color: #2FB3FB;
			}

			.checkmark {
				display: none;
				width: 16px;
				height: 16px;
				border-radius: 50%;
				background-color: transparent;
				color: white;
				text-align: center;
				line-height: 16px;
				font-size: 14px;
				font-weight: bold;
			}

			.circle.selected .checkmark {
				display: block;
			}

			.label {
				font-size: 14px;
				color: #808080;
			}

			.up-box {
				width: 336px;
				/* height: 112px; */
				border-radius: 8px;
				background: #F5F5F5;
				margin: 20px auto;
				padding: 30px 0px;
			}

			/* å¼¹çª—èƒŒæ™¯ */
			.modal {
				display: none;
				/* é»˜è®¤éšè— */
				position: fixed;
				z-index: 1;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				overflow: auto;
				background-color: rgba(0, 0, 0, 0.4);
			}

			.modal.show {
				display: flex;
				align-items: center;
				justify-content: center;
			}

			/* å¼¹çª—å†…å®¹ */
			.modal-content {

				background-color: #fefefe;
				/* margin: 50% auto 0%; */
				border: 1px solid #888;
				width: 300px;
				border-radius: 8px;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
				display: flex;
				flex-direction: column;
				align-items: center;
			}

			/* å…³é—­æŒ‰é’® */
			.close {
				color: #aaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
			}

			.close:hover,
			.close:focus {
				color: black;
				text-decoration: none;
				cursor: pointer;
			}

			/* æˆæƒæŒ‰é’® */
			#authorizeBtn {
				width: 100%;
				margin-top: 40px;
				height: 52px;
				line-height: 52px;
				text-align: center;
				color: white;
				border: none;
				cursor: pointer;
				font-size: 16px;
				color: #2FB3FB;
				border-top: 1px solid #E4E5E5;
			}

			.disflexShu {
				display: flex;
				flex-direction: column;
				align-items: center;
			}
		</style>
	</head>
	<body>

		<div id="app" style="display: flex;flex-direction: column;">
			<!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
			<!-- <custom-navbar title="åˆ›å»ºæ•°å­—äºº" :is-bg="ture"></custom-navbar> -->

			<!-- é¡¶éƒ¨å¯¼èˆª -->
			<div class="flex-between ">
				<div v-for="(item, index) in tabs" :key="index" class="top-item"
					:class="{active: isSelect === item.id}">
					<!-- @click="handleChange(item.id)" -->
					{{ item.label }}
				</div>
			</div>
			<div class="xuanfu">
				<!-- Tab å†…å®¹åŒºåŸŸ -->
				<!-- v-if="isSelect == 1||isSelect==2&&authorizeLz" -->
				<div style="height: 100%;" id='tabOne'>
					<div id='luzhi' style="height: 100%;">
						<video id="video" autoplay playsinline
							style="width:100%;height:100%;object-fit: cover;transform: scaleX(-1);"></video>
						<div class="camera-box">
							<div class="flex-between" style="margin-top: 18px;">
								<!-- <img style="width: 32px;height: 32px;" src="../static/chat/guanbi.png"
									@click="back" alt="" /> -->
								<div></div>
								<div id="countdown" class="countdown">
									00:00:{{seconds >9?seconds:('0'+seconds)}}
								</div>
								<img style="width: 28px;height: 28px;" src="../static/chat/fanzhuan.png"
									@click="getflip" alt="" />
							</div>

							<div class="camera-bor">
								<div class="camera-text" v-if="!authorizeLz">
									<div class="text1" style="color: #FFFFFF;">å½•åˆ¶æ—¶å¯ä»¥è‡ªç„¶å¾®ç¬‘ï¼Œä¿æŒæ”¾æ¾</div>
									<div class="text2">æ‚¨å¥½ï¼æˆ‘ç°åœ¨æ„Ÿè§‰å¾ˆå¥½ï¼Œè¯­è°ƒå¾ˆè½»ï¼Œæˆ‘å¾ˆæœ‰ä¿¡å¿ƒèƒ½åšå¥½è¿™æ¬¡è§†é¢‘å½•åˆ¶ã€‚æˆ‘ç°åœ¨å°±åœ¨é•œå¤´å‰ï¼Œå‡†å¤‡å¼€å§‹ã€‚</div>
									<div class="text1" style="color: #FFFFFF;">é—­ä¸Šå˜´ï¼Œç”¨é¼»å­å‘¼å¸ï¼Œåœé¡¿1s</div>
									<div class="text2">å…‰çº¿å¾ˆå¥½ï¼Œæˆ‘è„¸ä¸Šæ²¡æœ‰ä»»ä½•åˆºçœ¼çš„</div>
								</div>
								<div class="camera-text text2" v-if="authorizeLz">æˆ‘ {{userName}} æœ¬äººç‰¹æ­¤å£°æ˜ï¼Œæˆæƒæ‹“è¯Šä½¿ç”¨æˆ‘çš„è§†é¢‘åˆ›ä½œæ•°å­—äºº
								</div>
							</div>
							<div class="endTime ac" id='endTime'>{{endTime}}</div>
							<canvas id="mirrorCanvas" style="display: none;"></canvas>
							<button class="btn mt90 width163" @click="toggleRecord"
								v-if="!isTake&&!isRecording">å¼€å§‹å½•åˆ¶</button>
						</div>
					</div>
					<div id="videoUrl" style="height: 100%;padding: 0 20px;width: 335px;display: none;"
						class="disflexShu">
						<div class="video-box">
							<div class="trash-box">
								<img src="../static/chat/delVideo.png" style="width: 24px;height: 24px;"
									@click="handleDel" alt="" />
							</div>
							<video id="myVideo" class="video" show-fullscreen-btn='false' controls
								type="video/mp4"></video>
							<div class="text-box" id='tips' v-if="authorizeLz"></div>
						</div>
						<div v-if="!authorizeLz">
							<div class="text4">ä¸ºè·å¾—æ›´ä½³ã€æ›´é€¼çœŸçš„å¤´åƒï¼Œè¯·ç¡®è®¤è§†é¢‘ç¬¦åˆå¦‚ä¸‹éœ€æ±‚</div>
							<div class="grid" id="circleGrid"></div>
							<div style="display: flex;justify-content: center;">
								<button id='submitBtn' class="mt90 width163" @click="updateVideo">ç¡®è®¤æäº¤</button>
							</div>
						</div>
						<div v-if="authorizeLz" class="flex-between mt30"
							style="padding: 0px !important;width: 100% !important;justify-content: center;">
							<!-- <button class="btn1 width163" @click="handleChange">é‡æ–°æˆæƒ</button> -->
							<button class="width163" id="shouquantijiao" :class="isSbm?'btn2':'btn1'"
								style="margin: 0px !important;" @click="authorizeTijiao">æäº¤</button>
						</div>

					</div>


				</div>
				<div class="disflexShu" style="height: 100%;display: none" id='tabTwo'>
					<!-- <div>{{isSelect}}</div> -->
					<div style="display: flex;flex-direction: column;align-items: center;" id="tabTwoTop">
						<div id=videoShow class="videoShow">
							<video id="myVideoTwo" class="verticalVideo" show-fullscreen-btn='false' controls
								type="video/mp4"></video>
						</div>
						<div class="text4 mt30">ä¸ºäº†é˜²æ­¢æ»¥ç”¨æŠ€æœ¯ï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤åˆšåˆšæäº¤çš„è§†é¢‘æ˜¯ä½ æœ¬äºº</div>
						<video class="video" style='height: 172px;' v-if="videoTwo" :src="videoTwo"
							show-fullscreen-btn='false' controls type="video/mp4"></video>
						<button v-if="videoTwo" class="width163 btn mt30" @click="zenmirrorTijiao">æäº¤</button>

						<div class="up-box ac" v-if="!videoTwo">
							<img src="../static/chat/xiangji.png" style="width: 32px;height: 32px;" alt="" />
							<div class="text text3 mt10">è¯·ç¡®ä¿ä¸åˆšæ‰æ‹æ‘„æäº¤çš„è§†é¢‘ä¸ºåŒä¸€äºº</div>
							<div class="btn2" @click="handleSbm">å¼€å§‹å½•åˆ¶</div>

						</div>

						<!-- å¼¹çª— -->
						<div id="myModal" class="modal" @click.stop="myModalNone">
							<div class="modal-content">
								<!-- <span class="close">&times;</span> -->
								<div class="text5 mt20">æˆæƒæç¤º</div>
								<div style="margin-top: 27px;height: 30px;display: flex;align-items: center;">æˆ‘ <input
										type="text"
										style="width: 87px;height: 24px;line-height: 24px;text-align: center;margin: 0px 5px;"
										id="nameInput" placeholder="è¾“å…¥å§“å" @click.stop>
									å°†å¯¹æ‹“è¯Šè¿›è¡Œæˆæƒ</div>
								<div id="authorizeBtn" @click.stop="authorizeLuzhi">ç«‹å³æˆæƒå½•åˆ¶</div>
							</div>
						</div>
					</div>
					<!-- <div id='luzhitwo' style="height: 100%;display: none;">
						<video id="video" autoplay playsinline
							style="width:100%;height:100%;object-fit: cover;"></video>
						<div class="camera-box">
							<div class="flex-between" style="margin-top: 18px;">
								<img style="width: 32px;height: 32px;" src="../static/chat/guanbi.png"
									@click="handelClose" alt="" />
								<div id="countdown" class="countdown">
									00:00:{{times >9?times:('0'+times)}}
								</div>
								<img style="width: 28px;height: 28px;" src="../static/chat/fanzhuan.png" @click="getflip"
									alt="" />
							</div>

							<div class="camera-bor">
								<div class="camera-text text2">æˆ‘ {{userName}} æœ¬äººç‰¹æ­¤å£°æ˜ï¼Œæˆæƒæ‹“è¯Šä½¿ç”¨æˆ‘çš„è§†é¢‘åˆ›ä½œæ•°å­—äºº
								</div>
							</div>
							<div class="endTime ac" id='endTime'>{{endTime}}</div>
							<button class="btn mt90 width163" @click="toggleRecord"
								v-if="!isTake&&!isRecording">å¼€å§‹å½•åˆ¶</button>
						</div>
					</div> -->
					<!-- <div class="ac">
						<video :src="videoUrl" class="video"></video>
					</div> -->
				</div>
				<div id='tabThree' style="display: none;" class="ac mt90 disflexShu">
					<img src="@../static/chat/complete.png" style="width: 80px;height: 80px;" alt="" />
					<div class="text mt30">ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨ç”Ÿæˆä¸­...</div>
					<div class="text mt10">å¤§çº¦éœ€è¦10åˆ†é’Ÿ</div>
					<button class="btn mt90 width163" @click="back">è¿”å›é¦–é¡µ</button>
				</div>
			</div>
		</div>

		<script type="module">
			// Vue å®ä¾‹
			new Vue({
				el: '#app',
				data() {
					return {
						doctorId: null,
						isSelect: parseInt(new URLSearchParams(window.location.search).get('isSelect')) || 1,
						videoSrc: decodeURIComponent(new URLSearchParams(window.location.search).get('videoSrc') || ''),
						tabs: [{
								id: 1,
								label: 'ä¸Šä¼ é©±åŠ¨ç´ æ'
							},
							{
								id: 2,
								label: 'å½¢è±¡æˆæƒåˆ¶ä½œ'
							},
							{
								id: 3,
								label: 'ä¸Šä¼ æ–‡ä»¶åˆ¶ä½œ'
							}
						],
						tipsLabel: ['æ‚¨çš„è„¸éƒ¨å§‹ç»ˆæ¸…æ™°å¯è§', 'æ‚¨æ­£è§†ç€ç›¸æœº', 'æœ—è¯»å¥å­ä¹‹é—´æœ‰åœé¡¿', 'ç¯å¢ƒå®‰é™ï¼Œä¸”å…‰çº¿å……è¶³'],
						stream: null,
						mediaRecorder: null,
						recordedBlobs: [],
						isRecording: false,
						videoUrl: '',
						currentFacingMode: 'user',
						isTake: false,
						endTime: 3, //å€’è®¡æ—¶
						endTimeTwo: 3, //å€’è®¡æ—¶
						seconds: 5, //å½•åƒç§’æ•°
						isSubmit: false, //å¤šé€‰æ˜¯å¦å…¨é€‰çŠ¶æ€
						userName: '', //æˆæƒçš„åå­—
						authorizeLz: false, //æ˜¯å¦æ˜¯åœ¨å½¢è±¡æˆæƒå½•åˆ¶
						tips: 'æ–‡å­—æ£€æµ‹ä¸­...', //è§†é¢‘è¿”å›æç¤ºæ–‡æ¡ˆ
						isSbm: false, //è§†é¢‘æ˜¯å¦åˆæ ¼
						videoTwo: '', //äºŒæ¬¡è§†é¢‘æ–‡ä»¶
						_isDestroyed: false, // é˜²æ­¢ç»„ä»¶é”€æ¯åæ‰§è¡Œå›è°ƒ
						times: 3,
						oneTimer: null,
						twoTimer: null,
						mirrorStream: null,
						// å®šæ—¶å™¨ IDï¼ˆç”¨äº cancelAnimationFrameï¼‰
						oneTimerId: null,
						twoTimerId: null,

						// å€’è®¡æ—¶å¼€å§‹æ—¶é—´
						firstStartTime: null,
						secondStartTime: null,

						// é¡µé¢æ˜¯å¦å¯è§ï¼ˆç”¨äºæš‚åœå€’è®¡æ—¶ï¼‰
						isPageVisible: true,
						videoShow: true, //æ˜¯å¦æ˜¾ç¤ºè§†é¢‘é¡µé¢
					};
				},
				beforeDestroy() {
					// æ ‡è®°ç»„ä»¶å·²é”€æ¯ï¼Œé˜²æ­¢å¼‚æ­¥å›è°ƒæ‰§è¡Œ
					this._isDestroyed = true;

					// æ¸…é™¤å®šæ—¶å™¨
					//     if (this.countdownTimer) clearInterval(this.countdownTimer);
					//     if (this.recordTimer) clearInterval(this.recordTimer);

					//     // åœæ­¢å½•åˆ¶å¹¶é‡Šæ”¾èµ„æº
					//     if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
					//       this.mediaRecorder.stop();
					//     }
					//     if (this.stream) {
					//       this.stream.getTracks().forEach(track => track.stop());
					//     }

					//     this.mediaRecorder = null;
					this.stream = null;
				},
				methods: {
					handleSbm() { //æ‰“å¼€è¾“å…¥åå­—å¼¹çª—
						this.videoShow = false;
						document.getElementById('myVideoTwo').style.display = 'none';
						document.getElementById('myModal').style.display = 'flex';
						document.getElementById('myModal').classList.add('show');
					},
					myModalNone() { //å…³é—­è¾“å…¥åå­—å¼¹çª—
						document.getElementById('myVideoTwo').style.display = 'block';
						document.getElementById('myModal').style.display = 'none';
					},
					authorizeLuzhi() { //ç«‹å³æˆæƒå½•åˆ¶
						this.userName = document.getElementById('nameInput').value
						// document.getElementById('myVideoTwo').style.display='none';
						console.log(this.userName)
						this.authorizeLz = true;

						document.getElementById('tabTwo').style.display = 'none'
						document.getElementById('tabOne').style.display = 'block'
						document.getElementById('videoUrl').style.display = 'none'; // æ˜¾ç¤º div
						document.getElementById('luzhi').style.display = 'block'
						// document.getElementById('tabTwoTop').style.display = 'none'
						// this.seconds= 3; //å½•åƒç§’æ•°
						this.initCamera()
						this.myModalNone()
					},
					authorizeTijiao() { //æˆæƒæäº¤
						console.log('çŠ¶æ€', this.isSbm)
						if (!this.isSbm) return
						this.uploadFile(this.videoTwo, '/doctor/file/uploadauth')
						console.log('äºŒæ¬¡ç¡®è®¤')
					},
					handleChange(id) {
						this.isSelect = id;
					},
					videoChange(videoSrc) {
						if (this.authorizeLz) {
							this.videoTwo = videoSrc;
							document.getElementById('tabTwoTop').style.display = 'flex';
						} else {
							this.videoSrc = videoSrc;
							setTimeout(() => {
								document.getElementById('myVideoTwo').src = videoSrc
							}, 300)
						}

						this.isSelect = 2;
						document.getElementById('tabOne').style.display = 'none'
						document.getElementById('tabTwo').style.display = 'block'

					},
					back() {
						console.log(111, window.parent)
						// window.location.href = "/pages/home/index";
						window.parent.postMessage({
							type: 'navigate',
							action: 'goHome'
						}, '*')
					},
					async initCamera() {
						try {
							const video = document.getElementById('video');
							const canvas = document.getElementById('mirrorCanvas');
							const context = canvas.getContext('2d');

							if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
								throw new Error('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ mediaDevices.getUserMedia');
							}

							let constraints = {
								video: {
									facingMode: this.currentFacingMode
								},
								audio: false // å¦‚æœéœ€è¦å½•åˆ¶å£°éŸ³
							};

							const stream = await navigator.mediaDevices.getUserMedia(constraints);
							this.stream = stream;

							video.srcObject = stream;

							video.onloadedmetadata = () => {
								video.play();

								// è®¾ç½® canvas å°ºå¯¸ä¸è§†é¢‘ä¸€è‡´
								canvas.width = video.videoWidth;
								canvas.height = video.videoHeight;

								// åˆ›å»ºéé•œåƒçš„æµ
								const mirrorStream = canvas.captureStream();

								// æ·»åŠ éŸ³é¢‘è½¨é“ï¼ˆå¦‚æœéœ€è¦ï¼‰
								const audioTrack = stream.getAudioTracks()[0];
								if (audioTrack) {
									mirrorStream.addTrack(audioTrack);
								}

								// ä¿å­˜éé•œåƒæµï¼Œç”¨äºå½•åˆ¶
								this.mirrorStream = mirrorStream;

								// æ¯å¸§ç»˜åˆ¶å¹¶ç¿»è½¬ç”»é¢
								const drawFrame = () => {
									context.save();
									context.scale(-1, 1); // æ°´å¹³ç¿»è½¬ï¼ˆå–æ¶ˆé•œåƒï¼‰
									context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
									context.restore();
									requestAnimationFrame(drawFrame);
								};

								drawFrame();
							};

						} catch (err) {
							console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´:', err);
							alert(err.message);
						}
					},
					toggleRecord() { //å¼€å§‹å½•åˆ¶å€’è®¡æ—¶
						if (!this.isRecording) {
							if (!this.stream) {
								alert("è¯·å…ˆæ‰“å¼€æ‘„åƒå¤´")
								return
							}
							this.isTake = true;
							this.endTime = 3;

							document.getElementById('endTime').style.display = 'block'
							console.log('æŸ¥çœ‹', document.getElementById('endTime'))
							this.oneTimer = setInterval(() => {
								this.endTime = this.endTime-1;
								console.log('å€’è®¡æ—¶', this.endTime)
								if (this.endTime == 0 || this.endTimeTwo == 0) {
									document.getElementById('endTime').style.display = 'none'
									clearInterval(this.oneTimer)
									// this.endTime = 3;
									this.isTake = false;
									this.beginVideoPlay();
									const countdownEl = document.getElementById('countdown');
									if (countdownEl) {
										countdownEl.style.display = 'block';

										// ğŸ”¥ å…³é”®ï¼šå¼ºåˆ¶è§¦å‘é‡æ’ï¼Œè®© Safari ç«‹å³æ¸²æŸ“
										countdownEl.offsetHeight; // ä»»æ„è¯»å– layout å±æ€§å³å¯
									}
									// document.getElementById('countdown').style.display = 'block'
									this.seconds = 3;
									this.times = 3;
									// alert('å…ƒç´ ',countdownEl.innerText)
									this.twoTimer = setInterval(() => {
										// alert('æ˜¾ç¤º',this.seconds)
										this.seconds = this.seconds-1;
										// this.times--;
										if (this.seconds == 0) {
											clearInterval(this.twoTimer)
											this.beginVideoPlay();
											document.getElementById('countdown').style.display = 'none'
										}
									}, 1000)
								}
							}, 1000)
							// å¯åŠ¨ç¬¬ä¸€ä¸ªå€’è®¡æ—¶
							// this.startFirstCountdown();
						}
					},
					startFirstCountdown() {
						this.firstStartTime = performance.now();

						const step = (timestamp) => {
							const elapsed = timestamp - this.firstStartTime;
							const secondsElapsed = Math.floor(elapsed / 1000);

							// æ›´æ–°å€’è®¡æ—¶
							this.endTime = 3 - secondsElapsed;

							if (this.endTime <= 0) {
								// å€’è®¡æ—¶ç»“æŸ
								this.handleFirstCountdownEnd();
								return;
							}

							// ç»§ç»­ä¸‹ä¸€å¸§
							this.oneTimerId = requestAnimationFrame(step);
						};

						this.oneTimerId = requestAnimationFrame(step);
					},

					handleFirstCountdownEnd() {
						const endTimeEl = document.getElementById('endTime');
						if (endTimeEl) {
							endTimeEl.style.display = 'none';
						}
						this.isTake = false;
						this.beginVideoPlay(); // å¼€å§‹å½•åˆ¶/æ’­æ”¾

						// æ˜¾ç¤ºç¬¬äºŒä¸ªå€’è®¡æ—¶
						const countdownEl = document.getElementById('countdown');
						if (countdownEl) {
							countdownEl.style.display = 'block';
						}
						this.seconds = 5;
						this.times = 3;

						// å¯åŠ¨ç¬¬äºŒä¸ªå€’è®¡æ—¶
						this.startSecondCountdown();
					},

					startSecondCountdown() {
						this.secondStartTime = performance.now();

						const step = (timestamp) => {
							const elapsed = timestamp - this.secondStartTime;
							const secondsElapsed = Math.floor(elapsed / 1000);

							this.seconds = 5 - secondsElapsed;
							this.times = 3 - secondsElapsed;

							if (this.seconds <= 0) {
								// ç¬¬äºŒä¸ªå€’è®¡æ—¶ç»“æŸ
								this.handleSecondCountdownEnd();
								return;
							}

							this.twoTimerId = requestAnimationFrame(step);
						};

						this.twoTimerId = requestAnimationFrame(step);
					},

					handleSecondCountdownEnd() {
						this.beginVideoPlay(); // å¯èƒ½æ˜¯ç»“æŸå½•åˆ¶æˆ–åˆ‡æ¢çŠ¶æ€
						const countdownEl = document.getElementById('countdown');
						if (countdownEl) {
							countdownEl.style.display = 'none';
						}
						this.isRecording = false; // å¯é€‰ï¼šé‡ç½®å½•åˆ¶çŠ¶æ€
					},
					beginVideoPlay() { //å¼€å§‹å½•åˆ¶å¹¶æ‹¿ç»“æœ
						// å¼€å§‹å½•åˆ¶å¹¶æ‹¿ç»“æœ
						if (!this.mediaRecorder || this.mediaRecorder.state === 'inactive') {
							this.recordedBlobs = [];
							this.mediaRecorder = new MediaRecorder(this.mirrorStream, { // âœ… ä½¿ç”¨ mirrorStream
								mimeType: 'video/webm'
							});

							this.mediaRecorder.ondataavailable = event => {
								if (this._isDestroyed) return;
								if (event.data && event.data.size > 0) {
									this.recordedBlobs.push(event.data);
								}
							};

							this.mediaRecorder.onstop = () => {
								if (this._isDestroyed) return;
								const superBuffer = new Blob(this.recordedBlobs, {
									type: 'video/webm'
								});
								let url = URL.createObjectURL(superBuffer);
								this.urlFuzhi(url); // ä½ å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®è§†é¢‘é¢„è§ˆæˆ–ä¸Šä¼ 
							};

							this.mediaRecorder.start();
							this.isRecording = true;

						} else {
							this.mediaRecorder.stop();
							this.isRecording = false;
						}
					},
					urlFuzhi(url) {
						// è·å– video å…ƒç´ 
						const videoElement = document.getElementById('myVideo');
						console.log('çœ‹çœ‹', videoElement)
						videoElement.src = url;
						if (!this.authorizeLz) {
							this.videoSrc = url;
							let container = document.getElementById('circleGrid');
							this.tipsLabel.forEach((label, index) => {
								const option = document.createElement('div');
								option.classList.add('option');
								option.dataset.index = index;
								option.dataset.label = label;
								const circle = document.createElement('div');
								circle.classList.add('circle');
								circle.dataset.index = index;
								circle.dataset.label = label;
								// æ·»åŠ å¯¹å·å…ƒç´ 
								const checkmark = document.createElement('div');
								checkmark.classList.add('checkmark');
								checkmark.textContent = 'âœ“'; // ä½¿ç”¨ âœ“ å­—ç¬¦ä½œä¸ºå¯¹å·
								circle.appendChild(checkmark);
								const labelEl = document.createElement('div');
								labelEl.classList.add('label');
								labelEl.textContent = label;
								// ç‚¹å‡»æ•´è¡Œéƒ½å¯ä»¥åˆ‡æ¢é€‰ä¸­çŠ¶æ€
								option.addEventListener('click', () => {
									circle.classList.toggle('selected');
									this.updateSubmitButtonState(); // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
								});
								option.appendChild(circle);
								option.appendChild(labelEl);
								container.appendChild(option);
							});
							// åˆå§‹åŒ–æ—¶æ£€æŸ¥ä¸€æ¬¡æŒ‰é’®çŠ¶æ€
							this.updateSubmitButtonState();
						} else {
							this.videoTwo = url;
							this.checkDoctorAuth(this.doctorId, this.userName)
							document.getElementById('tips').innerText = 'æ–‡å­—æ£€æµ‹ä¸­...'
						}
						this.stopCamera()
						console.log(111, videoElement)
						document.getElementById('videoUrl').style.display = 'block'; // æ˜¾ç¤º div
						document.getElementById('luzhi').style.display = 'none'
						this.isRecording = false
					},
					// å…³é—­æ‘„åƒå¤´ (é€‚ç”¨äº H5)
					stopCamera() {
						if (this.stream) {
							const tracks = this.stream.getTracks();
							tracks.forEach(track => track.stop());
							this.stream = null;
							// this.videoSrc = null;
						}
						// this.showWebcam = false;
					},
					updateSubmitButtonState() { //æ˜¯å¦é€‰æ‹©
						const selectedCount = document.querySelectorAll('.circle.selected').length;
						const button = document.getElementById('submitBtn');
						if (selectedCount === this.tipsLabel.length) {
							console.log('å…¨éƒ¨')
							this.isSubmit = true;
							button.classList.add('btn');
							button.classList.remove('btn1');
						} else {
							this.isSubmit = false;
							button.classList.remove('btn');
							button.classList.add('btn1');
						}
						document.getElementById('videoUrl').style.display = 'block'
					},
					handleDel() { //åˆ é™¤è§†é¢‘ä»æ–°å½•åˆ¶
						console.log(1111)
						this.initCamera()
						this.videoSrc = '';
						document.getElementById('myVideo').src = '';
						document.getElementById('videoUrl').style.display = 'none'; // æ˜¾ç¤º div
						document.getElementById('luzhi').style.display = 'block'

						// document.getElementById('tabTwo').style.display='none';

						// isTake&&!isRecording
						if (this.authorizeLz) {
							document.getElementById('tabTwoTop').style.display = 'none';
							this.isTake = false;
							this.isRecording = false;
							// document.getElementById('tabTwo').remove('disflexShu')
						} else {
							document.getElementById('circleGrid').innerHTML = '';
						}

					},
					async getflip() {
						if (!this.stream) {
							alert("è¯·å…ˆæ‰“å¼€æ‘„åƒå¤´");
							return;
						}
						// åˆ‡æ¢æ‘„åƒå¤´æ–¹å‘
						this.currentFacingMode = this.currentFacingMode == 'user' ? 'environment' : 'user';
						// é‡æ–°åˆå§‹åŒ–æ‘„åƒå¤´
						this.initCamera();
					},
					handelClose() {
						console.log('å…³é—­')
					},
					updateVideo() {
						if (!this.isSubmit) return
						this.uploadFile(this.videoSrc, '/doctor/file/uploaddrive')
						console.log('-------------------------------------------------------------');


					},
					//åŸç”Ÿä¸Šä¼ æ–‡ä»¶æ¥å£
					uploadFile(file, url) {
						// let that=this;
						if (!file) {
							alert('è¯·ä¸Šä¼ è§†é¢‘æ–‡ä»¶');
							return;
						}

						fetch(file)
							.then(res => {
								if (!res.ok) throw new Error('è·å–è§†é¢‘å¤±è´¥');
								return res.blob();
							})
							.then(blob => {
								// 2. åˆ›å»ºä¸€ä¸ª File å¯¹è±¡ï¼ˆæ¨¡æ‹Ÿè§†é¢‘æ–‡ä»¶ï¼‰
								let videoFile = new File([blob], 'video.mp4', {
									type: blob.type || 'video/mp4'
								});

								// 3. æ„é€  FormData
								let formData = new FormData();
								formData.append('file', videoFile); // è§†é¢‘æ–‡ä»¶
								formData.append('doctorId', this.doctorId); // åŒ»ç”ŸID
								if (this.authorizeLz) {
									document.getElementById('shouquantijiao').disabled = true;
								} else {
									document.getElementById('submitBtn').disabled = true;
								}

								// 4. å‘èµ·ä¸Šä¼ è¯·æ±‚
								fetch(`http://47.108.20.93:26111/api${url}`, {
										method: 'POST',
										body: formData
									})
									.then(res => res.json())
									.then(obj => {
										console.log('ä¸Šä¼ æˆåŠŸ:', obj);
										if (obj.status == 0) {

											// alert('ä¸Šä¼ æˆåŠŸ');
											// this.videoUrl=obj.data
											this.videoChange(obj.data) //è¦æ³¨é‡Šçš„


										}
										// alert('ä¸Šä¼ æˆåŠŸ');
									})
									.catch(err => {
										console.error('ä¸Šä¼ å¤±è´¥:', err);
										alert('ä¸Šä¼ å¤±è´¥');
									})
									.finally(() => {
										if (this.authorizeLz) {
											document.getElementById('shouquantijiao').disabled = false;
										} else {
											document.getElementById('submitBtn').disabled = false;
										}
									});
							});
					},
					checkDoctorAuth(doctorId, doctorName) { //åŒ»ç”Ÿæ£€æµ‹
						const url =
							`http://47.108.20.93:26111/api/doctor/isdoctorauth?doctorId=${encodeURIComponent(doctorId)}&doctorName=${encodeURIComponent(doctorName)}`;

						var xhr = new XMLHttpRequest();
						xhr.open('GET', url, true);
						xhr.setRequestHeader('Content-Type', 'application/json');
						let that = this;
						xhr.onload = function() {
							if (xhr.status >= 200 && xhr.status < 300) {
								try {
									var res = JSON.parse(xhr.responseText);
									console.log('è¯·æ±‚æˆåŠŸ:', res);
									if (res?.data) {
										that.isSbm = true;
										document.getElementById('tips').innerText = 'æˆæƒæ–‡å­—å†…å®¹æ£€æµ‹ä¸€è‡´'
										document.getElementById('shouquantijiao').classList.add('btn2');
									} else {
										that.isSbm = false;
										document.getElementById('shouquantijiao').classList.add('btn1');
										document.getElementById('tips').innerText = 'æ‚¨ä¸Šä¼ çš„æˆæƒè§†é¢‘ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·æŒ‰è„šæœ¬çš„å†…å®¹æ¸…æ™°é˜…è¯»'
									}
								} catch (e) {
									console.error('JSON è§£æå¤±è´¥:', e);
								}
							} else {
								console.error('è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç :', xhr.status);
							}
						};

						xhr.onerror = function() {
							console.error('ç½‘ç»œé”™è¯¯');
						};

						xhr.send();
					},
					saveDoctorClone(params) {
						const url = 'http://47.108.20.93:26111/api/doctor/savedoctorclone';

						// è®¾ç½®è¯·æ±‚å¤´ï¼ˆæ ¹æ®åç«¯è¦æ±‚è°ƒæ•´ï¼‰
						const headers = {
							'Content-Type': 'application/json;charset=UTF-8'
						};

						// å‘èµ· fetch è¯·æ±‚
						return fetch(url, {
								method: 'POST',
								headers: headers,
								body: JSON.stringify(params)
							})
							.then(response => {
								if (!response.ok) {
									throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
								}
								return response.json(); // å‡è®¾è¿”å›çš„æ˜¯ JSON æ•°æ®
							})
							.then(res => {
								// return Promise.resolve(data); // æˆåŠŸè¿”å›æ•°æ®
								console.log('åˆ›å»º', res)
								if (res.status === 0) {
									// uni.showToast({
									// 	title: "åˆ›å»ºæ•°å­—äººæˆåŠŸ",
									// 	icon: "none"
									// })
									this.isSelect = 3;
									document.getElementById('tabThree').style.display = 'flex'
									document.getElementById('tabOne').style.display = 'none'
									document.getElementById('tabTwo').style.display = 'none'
									// setTimeout(() => {
									// 	uni.reLaunch({
									// 		url: "/pages/home/index"
									// 	})
									// }, 1000)
								}
							})
							.catch(error => {
								console.error('è¯·æ±‚å‡ºé”™:', error);
								return Promise.reject(error); // é”™è¯¯æŠ›å‡º
							});
					},

					//æäº¤ç¦…é•œ
					createCustomisedPerson(data) {
						console.log('ç¦…å¢ƒ')
						const accessToken = localStorage.getItem('AccessToken'); // æ›¿æ¢ uni.getStorageSync
						const url = "/chanjing/api/open/v1/create_customised_person";

						return new Promise((resolve, reject) => {
							fetch(url, {
									method: 'POST',
									headers: {
										'access_token': accessToken || '',
										'Content-Type': 'application/json; charset=utf-8'
									},
									body: JSON.stringify(data)
								})
								.then(response => {
									if (!response.ok) {
										throw new Error('Network response was not ok');
									}
									return response.json();
								})
								.then(res => {
									const code = res?.code || 0;
									const msg = res?.msg;
									if (code === 0) {
										resolve(res);
									} else if (code !== 1) {
										reject({
											code,
											msg
										});
									}
								})
								.catch(error => {
									reject({
										code: -1,
										msg: error.message
									});
								});
						});
					},

					// è·å– URL å‚æ•°
					getUrlParams(url) {
						let params = {};
						let parser = new URL(url);
						for (let [key, value] of parser.searchParams) {
							params[key] = value;
						}
						return params;
					},
					//æäº¤åˆ°ç¦…é•œ
					zenmirrorTijiao() {
						console.log('æ€»æäº¤', this.videoSrc)
						if (!this.videoSrc) return
						// ä¸Šä¼ ç¦…å¢ƒè¿”å›id
						let parms = {
							"name": this.doctorId,
							"material_video": this.videoSrc,
							"callback": "https://xx.com",
							"train_type": ""
						}
						let that = this;
						that.createCustomisedPerson(parms).then((res) => {
							if (res?.code === 0) {
								let doctorCloneDTO = {
									"cloneId": res.data,
									"doctorId": that.doctorId
								}
								console.log(that)
								that.saveDoctorClone(doctorCloneDTO);
							}
						})

					}
				},
				mounted() {
					let param = this.getUrlParams(window.location.href);
					// if (isSelect) {
					// 	console.log(videoSrc);
					// 	this.isSelect = parseInt(isSelect);
					// 	this.videoSrc = decodeURIComponent(videoSrc);
					// }
					// this.videoChange('http://tuozhen1.oss-cn-beijing.aliyuncs.com/Aizz/doctor/9000035/drive.mp4') //è¦æ³¨é‡Šçš„
					this.doctorId = param.doctorId;
					console.log('ID', param)
					if (param.videoSrc) {
						this.urlFuzhi(JSON.parse(param.videoSrc))
					}
					setTimeout(() => {
						this.initCamera()

					}, 300)
				}
			});
		</script>

	</body>
</html>